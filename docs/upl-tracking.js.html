<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>upl-tracking.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Config.html">Config</a><ul class='methods'><li data-type='method'><a href="Config.html#getCookieDomain">getCookieDomain</a></li><li data-type='method'><a href="Config.html#getDataInfrastructureUrl">getDataInfrastructureUrl</a></li><li data-type='method'><a href="Config.html#isValidEnvironment">isValidEnvironment</a></li><li data-type='method'><a href="Config.html#setEnvironment">setEnvironment</a></li></ul></li><li><a href="UplCookie.html">UplCookie</a><ul class='methods'><li data-type='method'><a href="UplCookie.html#.fromJSON">fromJSON</a></li><li data-type='method'><a href="UplCookie.html#.getCookieName">getCookieName</a></li><li data-type='method'><a href="UplCookie.html#getLocation">getLocation</a></li><li data-type='method'><a href="UplCookie.html#getTouchId">getTouchId</a></li><li data-type='method'><a href="UplCookie.html#save">save</a></li><li data-type='method'><a href="UplCookie.html#setLocation">setLocation</a></li><li data-type='method'><a href="UplCookie.html#setParameters">setParameters</a></li><li data-type='method'><a href="UplCookie.html#toJSON">toJSON</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-DataInfrastructureService.html">DataInfrastructureService</a><ul class='methods'><li data-type='method'><a href="module-DataInfrastructureService.html#.putRecord">putRecord</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#assignUserToTrackingId">assignUserToTrackingId</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#getInferedMedium">getInferedMedium</a></li><li><a href="global.html#getInferedSource">getInferedSource</a></li><li><a href="global.html#getReferrer">getReferrer</a></li><li><a href="global.html#getUrlParameters">getUrlParameters</a></li><li><a href="global.html#hasReferrer">hasReferrer</a></li><li><a href="global.html#i18nToUplLocale">i18nToUplLocale</a></li><li><a href="global.html#isCustomReferrer">isCustomReferrer</a></li><li><a href="global.html#isPageReload">isPageReload</a></li><li><a href="global.html#isUniplacesReferrer">isUniplacesReferrer</a></li><li><a href="global.html#setEnvironment">setEnvironment</a></li><li><a href="global.html#trackAction">trackAction</a></li><li><a href="global.html#trackTouch">trackTouch</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">upl-tracking.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import moment from 'moment';
import Cookies from 'js-cookie';
import UplCookie from './upl-cookie';
import { putRecord } from './services/data-infrastructure';
import { isUniplacesReferrer } from './referrer';
import { getUrlParameters } from './url-parameters';
import ActionsType from './enums/actions-type';
import UserType from './enums/user-type';
import EnvironmentType from './enums/environment-type';
import DataDeliveryStreamType from './enums/data-delivery-stream-type';
import PerformanceNavigationType from './enums/performance-navigation-type';
import config from './config';

/**
 * Set the environment for the library
 * @param {string} [environment=staging] - The environment
 */
function setEnvironment(environment = EnvironmentType.STAGING) {
  config.setEnvironment(environment);
}

/**
 * Track a new touch or update the existing one
 * @param {(Object|null)} [location=null] - The location's object
 * @return {Promise}
 */
function trackTouch(location = null) {
  const url = window.location.href;
  const params = getUrlParameters(url, location);

  let uplCookie = getCookie();
  if (!uplCookie) {
    uplCookie = new UplCookie();
  }

  if (isUniplacesReferrer() || isPageReload()) {
    return Promise.resolve();
  }

  uplCookie = uplCookie
    .setParameters(params)
    .setLocation(location)
    .save(config.getCookieDomain());

  return putRecord(DataDeliveryStreamType.UPL_TOUCHES, uplCookie.toJSON());
}

/**
 * Track an action
 * @param {string} actionType - The action's type
 * @return {Promise}
 */
function trackAction(actionType) {
  const uplCookie = getCookie();
  const record = {
    touch_id: uplCookie.getTouchId(),
    action: actionType,
    created_at: moment().valueOf()
  };

  return !uplCookie
    ? Promise.reject()
    : putRecord(DataDeliveryStreamType.UPL_ACTIONS, record);
}

/**
 * Assign a user ID to a tracking ID
 * @param {string} userId - The user's identifier
 * @param {string} [userType=guest] - The user's type
 * @return {Promise}
 */
function assignUserToTrackingId(userId, userType = UserType.GUEST) {
  const uplCookie = getCookie();
  const record = {
    tracking_id: uplCookie.tracking_id,
    user_type: userType,
    user_id: userId,
    created_at: moment().valueOf()
  };

  return !uplCookie
    ? Promise.reject()
    : putRecord(DataDeliveryStreamType.UPL_USERS, record);
}

/**
 * Get the current touch (a.k.a. Upl cookie)
 * @return {(UplCookie|null)}
 */
function getCookie() {
  const cookieName = UplCookie.getCookieName();
  const cookie = Cookies.getJSON(cookieName);

  return cookie ? UplCookie.fromJSON(cookie) : null;
}

/**
 * Check if the user accessed the page by reloading it
 * @return {bool}
 */
function isPageReload() {
  return window.performance &amp;&amp; window.performance.navigation.type === PerformanceNavigationType.RELOAD;
}

export {
  setEnvironment,
  trackTouch,
  trackAction,
  assignUserToTrackingId,
  ActionsType,
  getCookie,
  getUrlParameters
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Jul 17 2018 14:03:44 GMT+0100 (WEST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
